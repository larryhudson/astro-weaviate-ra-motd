---
import fs from "node:fs";
import { ingestBatch } from "@src/lib/weaviate/ingest_batch";

const password = Astro.url.searchParams.get("password");

const correctPassword = import.meta.env.VITE_INGEST_PASSWORD;

if (password !== correctPassword) {
    return new Response("Wrong password", { status: 401 });
}

if (Astro.request.method === "POST") {
    const jsonFilePath = import.meta.env.VITE_JSON_DATA_PATH;
    const jsonStr = fs.readFileSync(jsonFilePath, "utf8");
    console.log(jsonStr);
    const mixes = JSON.parse(jsonStr);
    await ingestBatch(mixes);
    return Astro.redirect("/");
}
---
